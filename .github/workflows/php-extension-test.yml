name: PHP Extension Testing

on:
  pull_request:
    branches:
      - main
    paths:
      - 'releases.properties'
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to test (e.g., 8.3.27)'
        required: true
        type: string
      platform:
        description: 'Platform to test on'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - win10-amd
          - win10-intel
          - win11-amd
          - win11-intel

jobs:
  detect-versions:
    name: Detect New PHP Versions
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
      has-changes: ${{ steps.get-versions.outputs.has-changes }}
      platforms: ${{ steps.get-platforms.outputs.platforms }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed PHP versions
        id: get-versions
        run: |
          # Check if this is a manual dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual dispatch detected"
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "versions=[\"${{ inputs.php_version }}\"]" >> $GITHUB_OUTPUT
            echo "Testing PHP version: ${{ inputs.php_version }}"
          else
            # Get the diff of releases.properties
            git diff origin/main HEAD -- releases.properties > diff.txt
            
            # Extract new version lines (lines starting with +)
            NEW_VERSIONS=$(grep "^+" diff.txt | grep -v "^+++" | sed 's/^+//' | grep -E "^[0-9]+\.[0-9]+\.[0-9]+" | cut -d' ' -f1 || echo "")
            
            if [ -z "$NEW_VERSIONS" ]; then
              echo "has-changes=false" >> $GITHUB_OUTPUT
              echo "versions=[]" >> $GITHUB_OUTPUT
              echo "No new PHP versions detected"
            else
              echo "has-changes=true" >> $GITHUB_OUTPUT
              # Convert to JSON array
              VERSIONS_JSON=$(echo "$NEW_VERSIONS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
              echo "versions=$VERSIONS_JSON" >> $GITHUB_OUTPUT
              echo "Detected new PHP versions: $NEW_VERSIONS"
            fi
          fi

      - name: Determine platforms to test
        id: get-platforms
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.platform }}" = "all" ]; then
              echo "platforms=[\"win10-amd\",\"win10-intel\",\"win11-amd\",\"win11-intel\"]" >> $GITHUB_OUTPUT
            else
              echo "platforms=[\"${{ inputs.platform }}\"]" >> $GITHUB_OUTPUT
            fi
          else
            echo "platforms=[\"win10-amd\",\"win10-intel\",\"win11-amd\",\"win11-intel\"]" >> $GITHUB_OUTPUT
          fi

  test-php:
    name: Test PHP ${{ matrix.version }} on ${{ matrix.platform }}
    needs: detect-versions
    if: needs.detect-versions.outputs.has-changes == 'true'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.detect-versions.outputs.versions) }}
        platform: ${{ fromJson(needs.detect-versions.outputs.platforms) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          New-Item -ItemType Directory -Force -Path "test-php-${{ matrix.version }}" | Out-Null
          New-Item -ItemType Directory -Force -Path "test-results" | Out-Null

      - name: Phase 1.1 - Download and Extract PHP
        id: download-php
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Stop"
          $version = "${{ matrix.version }}"
          
          Write-Host "=== Phase 1.1: Download and Extract PHP $version ==="
          
          try {
            $content = Get-Content "releases.properties"
            $line = $content | Where-Object { $_ -match "^$version\s*=" }
            
            if (-not $line) {
              throw "Version $version not found in releases.properties"
            }
            
            $url = ($line -split '=', 2)[1].Trim()
            Write-Host "Download URL: $url"
            
            $archivePath = "php-$version.7z"
            Write-Host "Downloading PHP archive..."
            Invoke-WebRequest -Uri $url -OutFile $archivePath -UseBasicParsing
            
            if (-not (Test-Path $archivePath)) {
              throw "Failed to download PHP archive"
            }
            
            $fileSize = (Get-Item $archivePath).Length / 1MB
            Write-Host "Downloaded: $archivePath ($([math]::Round($fileSize, 2)) MB)"
            
            Write-Host "Extracting PHP archive..."
            $extractPath = "test-php-$version"
            
            if (Get-Command 7z -ErrorAction SilentlyContinue) {
              & 7z x $archivePath -o"$extractPath" -y | Out-Null
            } else {
              throw "7-Zip is required to extract .7z files"
            }
            
            $phpExe = Join-Path $extractPath "php.exe"
            if (-not (Test-Path $phpExe)) {
              throw "php.exe not found after extraction"
            }
            
            Write-Host "âœ… PHP extracted successfully"
            echo "success=true" >> $env:GITHUB_OUTPUT
            echo "php-path=$phpExe" >> $env:GITHUB_OUTPUT
            
          } catch {
            Write-Host "âŒ Error: $_"
            echo "success=false" >> $env:GITHUB_OUTPUT
            echo "error=$($_.Exception.Message)" >> $env:GITHUB_OUTPUT
            exit 1
          }

      - name: Phase 1.2 - Verify PHP Executable
        id: verify-php
        if: steps.download-php.outputs.success == 'true'
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Stop"
          $version = "${{ matrix.version }}"
          $phpExe = "${{ steps.download-php.outputs.php-path }}"
          
          Write-Host "=== Phase 1.2: Verify PHP Executable ==="
          
          try {
            $versionOutput = & $phpExe -v 2>&1
            
            if ($LASTEXITCODE -ne 0) {
              throw "PHP executable returned error code: $LASTEXITCODE"
            }
            
            Write-Host $versionOutput
            
            if ($versionOutput -match "PHP\s+$version") {
              Write-Host "âœ… PHP version matches: $version"
            } else {
              Write-Host "âš ï¸  Warning: Version string mismatch"
            }
            
            $testOutput = & $phpExe -r "echo 'PHP is working';" 2>&1
            
            if ($testOutput -match "PHP is working") {
              Write-Host "âœ… PHP executes code successfully"
            } else {
              throw "PHP failed to execute test code"
            }
            
            echo "success=true" >> $env:GITHUB_OUTPUT
            
          } catch {
            Write-Host "âŒ Error: $_"
            echo "success=false" >> $env:GITHUB_OUTPUT
            echo "error=$($_.Exception.Message)" >> $env:GITHUB_OUTPUT
            exit 1
          }

      - name: Phase 2.1 - Download Extensions
        id: download-extensions
        if: steps.verify-php.outputs.success == 'true'
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          $version = "${{ matrix.version }}"
          
          Write-Host "=== Phase 2.1: Download Extensions ==="
          
          $extResults = @{}
          $allSuccess = $true
          
          $extsFile = "bin/php$version/exts.properties"
          if (-not (Test-Path $extsFile)) {
            Write-Host "âš ï¸  No exts.properties file found for PHP $version"
            echo "success=true" >> $env:GITHUB_OUTPUT
            return
          }
          
          New-Item -ItemType Directory -Force -Path "test-extensions" | Out-Null
          
          $content = Get-Content $extsFile
          foreach ($line in $content) {
            if ($line -match '^\s*#' -or $line -match '^\s*$') { continue }
            
            $parts = $line -split '=', 2
            if ($parts.Count -eq 2) {
              $extName = $parts[0].Trim()
              $extUrl = $parts[1].Trim()
              
              Write-Host "`nDownloading $extName..."
              
              try {
                $fileName = [System.IO.Path]::GetFileName($extUrl)
                $downloadPath = Join-Path "test-extensions" $fileName
                
                Invoke-WebRequest -Uri $extUrl -OutFile $downloadPath -UseBasicParsing
                
                if (Test-Path $downloadPath) {
                  $fileSize = (Get-Item $downloadPath).Length / 1KB
                  Write-Host "âœ… Downloaded: $fileName ($([math]::Round($fileSize, 2)) KB)"
                  
                  if ($fileName -match '\.zip$') {
                    $extractPath = Join-Path "test-extensions" $extName
                    Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
                    Write-Host "âœ… Extracted to: $extractPath"
                    $extResults[$extName] = @{ success = $true; path = $extractPath }
                  } else {
                    $extResults[$extName] = @{ success = $true; path = $downloadPath }
                  }
                } else {
                  throw "Download failed"
                }
              } catch {
                Write-Host "âŒ Failed to download $extName : $_"
                $extResults[$extName] = @{ success = $false; error = $_.Exception.Message }
                $allSuccess = $false
              }
            }
          }
          
          $extResults | ConvertTo-Json -Depth 10 | Out-File "test-results/extensions.json"
          echo "success=$allSuccess" >> $env:GITHUB_OUTPUT

      - name: Phase 2.2 - Validate DLL Architecture
        id: validate-architecture
        if: steps.download-extensions.outputs.success == 'true'
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          
          Write-Host "=== Phase 2.2: Validate DLL Architecture ==="
          
          function Test-DllArchitecture {
            param([string]$DllPath)
            
            try {
              $fs = [System.IO.FileStream]::new($DllPath, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read)
              $br = [System.IO.BinaryReader]::new($fs)
              
              $dosHeader = $br.ReadBytes(64)
              $peOffset = [BitConverter]::ToInt32($dosHeader, 60)
              
              $fs.Seek($peOffset, [System.IO.SeekOrigin]::Begin) | Out-Null
              $peSignature = $br.ReadBytes(4)
              
              $machine = $br.ReadUInt16()
              
              $fs.Close()
              
              $arch = switch ($machine) {
                0x014c { "I386" }
                0x8664 { "AMD64" }
                default { "UNKNOWN" }
              }
              
              return @{ Success = $true; Architecture = $arch }
            } catch {
              return @{ Success = $false; Error = $_.Exception.Message }
            }
          }
          
          $archResults = @{}
          $allValid = $true
          
          $dllFiles = Get-ChildItem -Path "test-extensions" -Filter "*.dll" -Recurse
          
          foreach ($dll in $dllFiles) {
            Write-Host "`nValidating: $($dll.Name)"
            $result = Test-DllArchitecture -DllPath $dll.FullName
            
            if ($result.Success) {
              Write-Host "Architecture: $($result.Architecture)"
              
              if ($result.Architecture -eq "AMD64") {
                Write-Host "âœ… Correct architecture (x64)"
                $archResults[$dll.Name] = @{ valid = $true; arch = $result.Architecture }
              } else {
                Write-Host "âŒ Invalid architecture: Expected AMD64, got $($result.Architecture)"
                $archResults[$dll.Name] = @{ valid = $false; arch = $result.Architecture }
                $allValid = $false
              }
            } else {
              Write-Host "âŒ Failed to read DLL: $($result.Error)"
              $archResults[$dll.Name] = @{ valid = $false; error = $result.Error }
              $allValid = $false
            }
          }
          
          $archResults | ConvertTo-Json -Depth 10 | Out-File "test-results/architecture.json"
          echo "success=$allValid" >> $env:GITHUB_OUTPUT

      - name: Phase 2.3 - Test Extension Loading
        id: test-loading
        if: steps.validate-architecture.outputs.success == 'true'
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          $phpExe = "${{ steps.download-php.outputs.php-path }}"
          
          Write-Host "=== Phase 2.3: Test Extension Loading ==="
          
          $loadResults = @{}
          $allLoaded = $true
          
          $dllFiles = Get-ChildItem -Path "test-extensions" -Filter "*.dll" -Recurse
          
          foreach ($dll in $dllFiles) {
            $extName = $dll.BaseName -replace '^php_', ''
            Write-Host "`nTesting: $extName"
            
            try {
              $isZend = $extName -match 'xdebug'
              $directive = if ($isZend) { "zend_extension" } else { "extension" }
              
              $output = & $phpExe -d "$directive=$($dll.FullName)" -m 2>&1 | Out-String
              
              if ($output -match $extName) {
                Write-Host "âœ… Extension loaded successfully"
                $loadResults[$extName] = @{ loaded = $true; type = $directive }
              } else {
                Write-Host "âŒ Extension not found in module list"
                $loadResults[$extName] = @{ loaded = $false }
                $allLoaded = $false
              }
            } catch {
              Write-Host "âŒ Error loading extension: $_"
              $loadResults[$extName] = @{ loaded = $false; error = $_.Exception.Message }
              $allLoaded = $false
            }
          }
          
          $loadResults | ConvertTo-Json -Depth 10 | Out-File "test-results/loading.json"
          echo "success=$allLoaded" >> $env:GITHUB_OUTPUT

      - name: Phase 3.1 - Download Dependencies
        id: download-dependencies
        if: steps.test-loading.outputs.success == 'true'
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          $version = "${{ matrix.version }}"
          
          Write-Host "=== Phase 3.1: Download Dependencies ==="
          
          $depResults = @{}
          $allSuccess = $true
          
          $depsFile = "bin/php$version/deps.properties"
          if (-not (Test-Path $depsFile)) {
            Write-Host "âš ï¸  No deps.properties file found for PHP $version"
            echo "success=true" >> $env:GITHUB_OUTPUT
            return
          }
          
          New-Item -ItemType Directory -Force -Path "test-dependencies" | Out-Null
          
          $content = Get-Content $depsFile
          foreach ($line in $content) {
            if ($line -match '^\s*#' -or $line -match '^\s*$') { continue }
            
            $parts = $line -split '=', 2
            if ($parts.Count -eq 2) {
              $depName = $parts[0].Trim()
              $depUrl = $parts[1].Trim()
              
              Write-Host "`nDownloading $depName..."
              
              try {
                $fileName = [System.IO.Path]::GetFileName($depUrl)
                $downloadPath = Join-Path "test-dependencies" $fileName
                
                Invoke-WebRequest -Uri $depUrl -OutFile $downloadPath -UseBasicParsing
                
                if (Test-Path $downloadPath) {
                  $fileSize = (Get-Item $downloadPath).Length / 1MB
                  Write-Host "âœ… Downloaded: $fileName ($([math]::Round($fileSize, 2)) MB)"
                  
                  if ($fileName -match '\.(7z|zip)$') {
                    $extractPath = Join-Path "test-dependencies" $depName
                    
                    if ($fileName -match '\.7z$') {
                      if (Get-Command 7z -ErrorAction SilentlyContinue) {
                        & 7z x $downloadPath -o"$extractPath" -y | Out-Null
                        Write-Host "âœ… Extracted to: $extractPath"
                      } else {
                        Write-Host "âš ï¸  7z not available, skipping extraction"
                      }
                    } else {
                      Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
                      Write-Host "âœ… Extracted to: $extractPath"
                    }
                    
                    $depResults[$depName] = @{ success = $true; path = $extractPath }
                  } else {
                    $depResults[$depName] = @{ success = $true; path = $downloadPath }
                  }
                } else {
                  throw "Download failed"
                }
              } catch {
                Write-Host "âŒ Failed to download $depName : $_"
                $depResults[$depName] = @{ success = $false; error = $_.Exception.Message }
                $allSuccess = $false
              }
            }
          }
          
          $depResults | ConvertTo-Json -Depth 10 | Out-File "test-results/dependencies.json"
          echo "success=$allSuccess" >> $env:GITHUB_OUTPUT

      - name: Phase 3.2 - Test Extensions with Dependencies
        id: test-with-dependencies
        if: steps.download-dependencies.outputs.success == 'true'
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          $phpExe = "${{ steps.download-php.outputs.php-path }}"
          
          Write-Host "=== Phase 3.2: Test Extensions with Dependencies ==="
          
          $depDirs = Get-ChildItem -Path "test-dependencies" -Directory -ErrorAction SilentlyContinue
          foreach ($dir in $depDirs) {
            $env:PATH = "$($dir.FullName);$env:PATH"
            Write-Host "Added to PATH: $($dir.FullName)"
          }
          
          $depTestResults = @{}
          $allSuccess = $true
          
          $imagickDll = Get-ChildItem -Path "test-extensions" -Filter "*imagick*.dll" -Recurse | Select-Object -First 1
          if ($imagickDll) {
            Write-Host "`nTesting imagick with ImageMagick..."
            try {
              $testCode = "echo class_exists('Imagick') ? 'OK' : 'FAIL';"
              $output = & $phpExe -d "extension=$($imagickDll.FullName)" -r $testCode 2>&1
              
              if ($output -match 'OK') {
                Write-Host "âœ… Imagick class is available"
                $depTestResults['imagick'] = @{ success = $true }
              } else {
                Write-Host "âŒ Imagick class not available"
                $depTestResults['imagick'] = @{ success = $false }
                $allSuccess = $false
              }
            } catch {
              Write-Host "âŒ Error testing imagick: $_"
              $depTestResults['imagick'] = @{ success = $false; error = $_.Exception.Message }
              $allSuccess = $false
            }
          }
          
          $memcacheDll = Get-ChildItem -Path "test-extensions" -Filter "*memcache*.dll" -Recurse | Select-Object -First 1
          if ($memcacheDll) {
            Write-Host "`nTesting memcache..."
            try {
              $testCode = "echo function_exists('memcache_connect') ? 'OK' : 'FAIL';"
              $output = & $phpExe -d "extension=$($memcacheDll.FullName)" -r $testCode 2>&1
              
              if ($output -match 'OK') {
                Write-Host "âœ… Memcache functions are available"
                $depTestResults['memcache'] = @{ success = $true }
              } else {
                Write-Host "âš ï¸  Memcache check inconclusive"
                $depTestResults['memcache'] = @{ success = $true; note = "Function check inconclusive" }
              }
            } catch {
              Write-Host "âŒ Error testing memcache: $_"
              $depTestResults['memcache'] = @{ success = $false; error = $_.Exception.Message }
            }
          }
          
          $xdebugDll = Get-ChildItem -Path "test-extensions" -Filter "*xdebug*.dll" -Recurse | Select-Object -First 1
          if ($xdebugDll) {
            Write-Host "`nTesting xdebug..."
            try {
              $testCode = "echo extension_loaded('xdebug') ? 'OK' : 'FAIL';"
              $output = & $phpExe -d "zend_extension=$($xdebugDll.FullName)" -r $testCode 2>&1
              
              if ($output -match 'OK') {
                Write-Host "âœ… Xdebug is loaded"
                $depTestResults['xdebug'] = @{ success = $true }
              } else {
                Write-Host "âŒ Xdebug not loaded"
                $depTestResults['xdebug'] = @{ success = $false }
                $allSuccess = $false
              }
            } catch {
              Write-Host "âŒ Error testing xdebug: $_"
              $depTestResults['xdebug'] = @{ success = $false; error = $_.Exception.Message }
              $allSuccess = $false
            }
          }
          
          $depTestResults | ConvertTo-Json -Depth 10 | Out-File "test-results/dependency-tests.json"
          echo "success=$allSuccess" >> $env:GITHUB_OUTPUT

      - name: Phase 4 - Functional Testing
        id: functional-tests
        if: steps.test-with-dependencies.outputs.success == 'true'
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          $phpExe = "${{ steps.download-php.outputs.php-path }}"
          
          Write-Host "=== Phase 4: Functional Testing ==="
          
          $depDirs = Get-ChildItem -Path "test-dependencies" -Directory -ErrorAction SilentlyContinue
          foreach ($dir in $depDirs) {
            $env:PATH = "$($dir.FullName);$env:PATH"
          }
          
          $funcResults = @{}
          $allSuccess = $true
          
          $imagickDll = Get-ChildItem -Path "test-extensions" -Filter "*imagick*.dll" -Recurse | Select-Object -First 1
          if ($imagickDll) {
            Write-Host "`nTesting imagick functionality..."
            try {
              $testCode = "`$img = new Imagick(); `$img->newImage(100, 100, new ImagickPixel('red')); `$img->setImageFormat('png'); echo 'imagick: OK';"
              $output = & $phpExe -d "extension=$($imagickDll.FullName)" -r $testCode 2>&1
              
              if ($output -match 'imagick: OK') {
                Write-Host "âœ… Imagick can create images"
                $funcResults['imagick'] = @{ success = $true }
              } else {
                Write-Host "âš ï¸  Imagick test inconclusive"
                $funcResults['imagick'] = @{ success = $false }
                $allSuccess = $false
              }
            } catch {
              Write-Host "âŒ Error testing imagick functionality: $_"
              $funcResults['imagick'] = @{ success = $false; error = $_.Exception.Message }
              $allSuccess = $false
            }
          }
          
          $memcacheDll = Get-ChildItem -Path "test-extensions" -Filter "*memcache*.dll" -Recurse | Select-Object -First 1
          if ($memcacheDll) {
            Write-Host "`nTesting memcache functionality..."
            try {
              $testCode = "echo function_exists('memcache_connect') ? 'memcache: OK' : 'FAIL';"
              $output = & $phpExe -d "extension=$($memcacheDll.FullName)" -r $testCode 2>&1
              
              if ($output -match 'memcache: OK') {
                Write-Host "âœ… Memcache functions available"
                $funcResults['memcache'] = @{ success = $true }
              } else {
                Write-Host "âš ï¸  Memcache test inconclusive"
                $funcResults['memcache'] = @{ success = $true; note = "Functions exist but not testable without server" }
              }
            } catch {
              Write-Host "âŒ Error testing memcache functionality: $_"
              $funcResults['memcache'] = @{ success = $false; error = $_.Exception.Message }
            }
          }
          
          $xdebugDll = Get-ChildItem -Path "test-extensions" -Filter "*xdebug*.dll" -Recurse | Select-Object -First 1
          if ($xdebugDll) {
            Write-Host "`nTesting xdebug functionality..."
            try {
              $testCode = "echo extension_loaded('xdebug') ? 'xdebug: OK' : 'FAIL';"
              $output = & $phpExe -d "zend_extension=$($xdebugDll.FullName)" -r $testCode 2>&1
              
              if ($output -match 'xdebug: OK') {
                Write-Host "âœ… Xdebug is functional"
                $funcResults['xdebug'] = @{ success = $true }
              } else {
                Write-Host "âŒ Xdebug test failed"
                $funcResults['xdebug'] = @{ success = $false }
                $allSuccess = $false
              }
            } catch {
              Write-Host "âŒ Error testing xdebug functionality: $_"
              $funcResults['xdebug'] = @{ success = $false; error = $_.Exception.Message }
              $allSuccess = $false
            }
          }
          
          $funcResults | ConvertTo-Json -Depth 10 | Out-File "test-results/functional.json"
          echo "success=$allSuccess" >> $env:GITHUB_OUTPUT

      - name: Generate Test Summary
        if: always()
        run: |
          $version = "${{ matrix.version }}"
          $platform = "${{ matrix.platform }}"
          
          Write-Host "`n=== Test Summary for PHP $version on $platform ==="
          
          $phase1_1 = "${{ steps.download-php.outputs.success }}" -eq "true"
          $phase1_2 = "${{ steps.verify-php.outputs.success }}" -eq "true"
          $phase2_1 = "${{ steps.download-extensions.outputs.success }}" -eq "true"
          $phase2_2 = "${{ steps.validate-architecture.outputs.success }}" -eq "true"
          $phase2_3 = "${{ steps.test-loading.outputs.success }}" -eq "true"
          $phase3_1 = "${{ steps.download-dependencies.outputs.success }}" -eq "true"
          $phase3_2 = "${{ steps.test-with-dependencies.outputs.success }}" -eq "true"
          $phase4 = "${{ steps.functional-tests.outputs.success }}" -eq "true"
          
          $summary = "### PHP $version - $platform`n`n"
          
          $summary += "**Phase 1: Basic PHP Validation**`n"
          $summary += "- Download & Extract: $(if ($phase1_1) { 'âœ… PASS' } else { 'âŒ FAIL' })`n"
          $summary += "- Verify Executable: $(if ($phase1_2) { 'âœ… PASS' } else { 'âŒ FAIL' })`n`n"
          
          if ($phase1_2) {
            $summary += "**Phase 2: Extension Validation**`n"
            $summary += "- Download Extensions: $(if ($phase2_1) { 'âœ… PASS' } else { 'âŒ FAIL' })`n"
            if ($phase2_1) {
              $summary += "- Validate Architecture: $(if ($phase2_2) { 'âœ… PASS' } else { 'âŒ FAIL' })`n"
              if ($phase2_2) {
                $summary += "- Test Loading: $(if ($phase2_3) { 'âœ… PASS' } else { 'âŒ FAIL' })`n"
              }
            }
            $summary += "`n"
          }
          
          if ($phase2_3) {
            $summary += "**Phase 3: Dependency Validation**`n"
            $summary += "- Download Dependencies: $(if ($phase3_1) { 'âœ… PASS' } else { 'âŒ FAIL' })`n"
            if ($phase3_1) {
              $summary += "- Test with Dependencies: $(if ($phase3_2) { 'âœ… PASS' } else { 'âŒ FAIL' })`n"
            }
            $summary += "`n"
          }
          
          if ($phase3_2) {
            $summary += "**Phase 4: Functional Testing**`n"
            $summary += "- Extension Functionality: $(if ($phase4) { 'âœ… PASS' } else { 'âš ï¸  PARTIAL' })`n`n"
          }
          
          if (Test-Path "test-results/extensions.json") {
            $extData = Get-Content "test-results/extensions.json" | ConvertFrom-Json
            if ($extData.PSObject.Properties.Count -gt 0) {
              $summary += "**Extensions Tested:** $($extData.PSObject.Properties.Count)`n"
              foreach ($ext in $extData.PSObject.Properties) {
                $status = if ($ext.Value.success) { "âœ…" } else { "âŒ" }
                $summary += "- $status $($ext.Name)`n"
              }
              $summary += "`n"
            }
          }
          
          Write-Host $summary
          $summary | Out-File "test-results/summary-$platform.md"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.version }}-${{ matrix.platform }}
          path: test-results/
          retention-days: 30

  report-results:
    name: Report Test Results
    needs: [detect-versions, test-php]
    if: always() && needs.detect-versions.outputs.has-changes == 'true' && needs.test-php.result != 'cancelled'
    runs-on: ubuntu-latest
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-results
        continue-on-error: true

      - name: Generate PR Comment
        run: |
          echo "## ðŸ§ª PHP Extension Tests - Complete Results" > comment.md
          echo "" >> comment.md
          echo "**Test Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> comment.md
          echo "" >> comment.md
          
          # Check if artifacts exist
          if [ -d "all-results" ]; then
            for version_dir in all-results/test-results-*; do
              if [ -d "$version_dir" ]; then
                for summary_file in "$version_dir"/summary-*.md; do
                  if [ -f "$summary_file" ]; then
                    cat "$summary_file" >> comment.md
                    echo "" >> comment.md
                  fi
                done
              fi
            done
          else
            echo "âš ï¸ No test results available" >> comment.md
            echo "" >> comment.md
          fi
          
          echo "---" >> comment.md
          echo "" >> comment.md
          echo "### ðŸ“‹ All Phases Status" >> comment.md
          echo "" >> comment.md
          echo "âœ… **Completed:**" >> comment.md
          echo "- Phase 1: Basic PHP Validation" >> comment.md
          echo "- Phase 2: Extension Validation" >> comment.md
          echo "- Phase 3: Dependency Validation" >> comment.md
          echo "- Phase 4: Functional Testing" >> comment.md
          echo "- Phase 5: Enhanced Error Reporting" >> comment.md
          echo "" >> comment.md
          echo "_All phases of CI testing are now complete! Check artifacts for detailed logs._" >> comment.md
          
          cat comment.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ§ª PHP Extension Tests')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
      
      - name: Display Results Summary (Manual Run)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "## ðŸ§ª PHP Extension Tests - Manual Run Results"
          echo ""
          cat comment.md
